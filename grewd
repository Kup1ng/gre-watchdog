#!/usr/bin/env bash
set -euo pipefail

PY_DST="/usr/local/sbin/gre-watchdog.py"
SVC="/etc/systemd/system/gre-watchdog.service"
TMR="/etc/systemd/system/gre-watchdog.timer"
STATE="/run/gre-watchdog.json"

need_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "ERROR: run as root" >&2
    exit 1
  fi
}

role_from_service() {
  if [[ -f "$SVC" ]]; then
    grep -oE -- '--role (ir|kh)' "$SVC" | awk '{print $2}' | head -n1 || true
  fi
}

gre_counts() {
  local role="${1:-}"
  local pattern='^gre-'
  if [[ "$role" == "ir" ]]; then pattern='^gre-ir-'; fi
  if [[ "$role" == "kh" ]]; then pattern='^gre-kh-'; fi

  local all up down
  all="$(ip -o link show | awk -F': ' '{print $2}' | awk '{print $1}' | grep -E "$pattern" || true)"
  up="$(ip -o link show up | awk -F': ' '{print $2}' | awk '{print $1}' | grep -E "$pattern" || true)"
  down="$(comm -23 <(printf "%s\n" "$all" | sort) <(printf "%s\n" "$up" | sort) || true)"

  echo "Interfaces total: $(printf "%s\n" "$all" | sed '/^$/d' | wc -l)"
  echo "Interfaces UP:    $(printf "%s\n" "$up"  | sed '/^$/d' | wc -l)"
  echo "Interfaces DOWN:  $(printf "%s\n" "$down"| sed '/^$/d' | wc -l)"
}

cmd_status() {
  local role
  role="$(role_from_service)"
  echo "Service: $(systemctl is-active gre-watchdog.service 2>/dev/null || true)"
  echo "Timer:   $(systemctl is-active gre-watchdog.timer 2>/dev/null || true)"
  echo "Role:    ${role:-unknown}"
  echo
  gre_counts "${role:-}"
}

cmd_logs() {
  TZ="Asia/Tehran" journalctl -u gre-watchdog.service --since "1 hour ago" --no-pager
}

cmd_start() { need_root; systemctl enable --now gre-watchdog.timer >/dev/null 2>&1 || true; echo "[+] Started."; }
cmd_stop()  { need_root; systemctl stop gre-watchdog.timer >/dev/null 2>&1 || true; echo "[+] Stopped."; }
cmd_restart(){ need_root; systemctl restart gre-watchdog.timer >/dev/null 2>&1 || true; echo "[+] Restarted."; }

cmd_reset() {
  need_root
  if [[ -f "$STATE" ]]; then
    rm -f "$STATE"
    echo "[+] State reset (consecutive, cooldown, next_up cleared)."
  else
    echo "[*] No state file found."
  fi
}

usage() {
  cat <<EOF
Usage: grewd <command>

Commands:
  status        Show service/timer state and GRE counts
  logs          Show last 1 hour logs (Tehran time)
  start         Enable+start timer
  stop          Stop timer
  restart       Restart timer
  reset         Clear watchdog state (no uninstall)
EOF
}

main() {
  local cmd="${1:-status}"
  case "$cmd" in
    status) cmd_status ;;
    logs) cmd_logs ;;
    start) cmd_start ;;
    stop) cmd_stop ;;
    restart) cmd_restart ;;
    reset) cmd_reset ;;
    *) usage; exit 1 ;;
  esac
}

main "$@"
